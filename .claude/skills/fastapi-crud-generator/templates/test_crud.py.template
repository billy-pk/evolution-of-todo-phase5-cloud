"""
Test Suite for {ModelName} CRUD Operations

Generated by fastapi-crud-generator skill
Tests: Create, Read, Update, Delete, List, User Isolation
"""

import pytest
from uuid import uuid4


# ===== CREATE Tests =====

def test_create_{resource}(client, test_user_id):
    """Test creating a new {resource}"""
    response = client.post(
        f"/api/{test_user_id}/{resources}",
        json={
            # Add your field values here
            # "title": "Test {resource}",
            # "description": "Test description",
            # "priority": 3
        }
    )

    assert response.status_code == 201
    data = response.json()

    # Verify response contains expected fields
    assert "id" in data
    assert data["user_id"] == test_user_id
    # Add assertions for custom fields
    # assert data["title"] == "Test {resource}"
    # assert data["priority"] == 3
    assert "created_at" in data
    assert "updated_at" in data


def test_create_{resource}_validation_error(client, test_user_id):
    """Test creating {resource} with invalid data returns 422"""
    response = client.post(
        f"/api/{test_user_id}/{resources}",
        json={
            # Missing required fields or invalid values
            # Example: title too long
            # "title": "x" * 300,  # Exceeds max_length
        }
    )

    assert response.status_code == 422  # Validation error


# ===== LIST Tests =====

def test_list_{resources}_empty(client, test_user_id):
    """Test listing {resources} when none exist"""
    response = client.get(f"/api/{test_user_id}/{resources}")

    assert response.status_code == 200
    data = response.json()
    assert "{resources}" in data
    assert data["{resources}"] == []
    assert data["total"] == 0


def test_list_{resources}_with_data(client, test_user_id):
    """Test listing {resources} after creating some"""
    # Create multiple {resources}
    for i in range(3):
        client.post(
            f"/api/{test_user_id}/{resources}",
            json={
                # Add varying test data
                # "title": f"Test {resource} {i}",
                # "priority": i + 1
            }
        )

    # List them
    response = client.get(f"/api/{test_user_id}/{resources}")

    assert response.status_code == 200
    data = response.json()
    assert len(data["{resources}"]) == 3
    assert data["total"] == 3


def test_list_{resources}_pagination(client, test_user_id):
    """Test pagination with skip and limit"""
    # Create 10 {resources}
    for i in range(10):
        client.post(
            f"/api/{test_user_id}/{resources}",
            json={
                # "title": f"Test {resource} {i}"
            }
        )

    # Get first 5
    response = client.get(f"/api/{test_user_id}/{resources}?skip=0&limit=5")
    assert response.status_code == 200
    data = response.json()
    assert len(data["{resources}"]) == 5

    # Get next 5
    response = client.get(f"/api/{test_user_id}/{resources}?skip=5&limit=5")
    assert response.status_code == 200
    data = response.json()
    assert len(data["{resources}"]) == 5


# ===== READ Tests =====

def test_get_{resource}_success(client, test_user_id):
    """Test getting a single {resource} by ID"""
    # Create a {resource} first
    create_response = client.post(
        f"/api/{test_user_id}/{resources}",
        json={
            # "title": "Test {resource}"
        }
    )
    {resource}_id = create_response.json()["id"]

    # Get it
    response = client.get(f"/api/{test_user_id}/{resources}/{{{resource}_id}}")

    assert response.status_code == 200
    data = response.json()
    assert data["id"] == {resource}_id
    assert data["user_id"] == test_user_id


def test_get_{resource}_not_found(client, test_user_id):
    """Test getting a non-existent {resource} returns 404"""
    fake_id = str(uuid4())
    response = client.get(f"/api/{test_user_id}/{resources}/{fake_id}")

    assert response.status_code == 404
    assert "not found" in response.json()["detail"].lower()


# ===== UPDATE Tests =====

def test_update_{resource}_success(client, test_user_id):
    """Test updating a {resource}"""
    # Create a {resource} first
    create_response = client.post(
        f"/api/{test_user_id}/{resources}",
        json={
            # "title": "Original Title",
            # "priority": 1
        }
    )
    {resource}_id = create_response.json()["id"]

    # Update it
    response = client.put(
        f"/api/{test_user_id}/{resources}/{{{resource}_id}}",
        json={
            # "title": "Updated Title",
            # "priority": 5
        }
    )

    assert response.status_code == 200
    data = response.json()
    assert data["id"] == {resource}_id
    # assert data["title"] == "Updated Title"
    # assert data["priority"] == 5
    # Verify updated_at changed
    assert data["updated_at"] != create_response.json()["updated_at"]


def test_update_{resource}_partial(client, test_user_id):
    """Test partial update (only some fields)"""
    # Create a {resource}
    create_response = client.post(
        f"/api/{test_user_id}/{resources}",
        json={
            # "title": "Original Title",
            # "description": "Original Description",
            # "priority": 1
        }
    )
    {resource}_id = create_response.json()["id"]

    # Update only one field
    response = client.put(
        f"/api/{test_user_id}/{resources}/{{{resource}_id}}",
        json={
            # "priority": 5  # Only update priority
        }
    )

    assert response.status_code == 200
    data = response.json()
    # assert data["title"] == "Original Title"  # Unchanged
    # assert data["priority"] == 5  # Changed


def test_update_{resource}_not_found(client, test_user_id):
    """Test updating a non-existent {resource} returns 404"""
    fake_id = str(uuid4())
    response = client.put(
        f"/api/{test_user_id}/{resources}/{fake_id}",
        json={
            # "title": "Updated"
        }
    )

    assert response.status_code == 404


# ===== DELETE Tests =====

def test_delete_{resource}_success(client, test_user_id):
    """Test deleting a {resource}"""
    # Create a {resource} first
    create_response = client.post(
        f"/api/{test_user_id}/{resources}",
        json={
            # "title": "To be deleted"
        }
    )
    {resource}_id = create_response.json()["id"]

    # Delete it
    response = client.delete(f"/api/{test_user_id}/{resources}/{{{resource}_id}}")

    assert response.status_code == 204

    # Verify it's gone
    get_response = client.get(f"/api/{test_user_id}/{resources}/{{{resource}_id}}")
    assert get_response.status_code == 404


def test_delete_{resource}_not_found(client, test_user_id):
    """Test deleting a non-existent {resource} returns 404"""
    fake_id = str(uuid4())
    response = client.delete(f"/api/{test_user_id}/{resources}/{fake_id}")

    assert response.status_code == 404


# ===== USER ISOLATION Tests =====

def test_user_cannot_list_other_users_{resources}(client, test_user_id, another_test_user_id):
    """Test that users cannot see each other's {resources}"""
    # User A creates a {resource}
    client.post(
        f"/api/{test_user_id}/{resources}",
        json={
            # "title": "User A's {resource}"
        }
    )

    # User B creates a {resource}
    client.post(
        f"/api/{another_test_user_id}/{resources}",
        json={
            # "title": "User B's {resource}"
        }
    )

    # User A lists their {resources} (should only see their own)
    response_a = client.get(f"/api/{test_user_id}/{resources}")
    data_a = response_a.json()
    assert data_a["total"] == 1
    # assert data_a["{resources}"][0]["title"] == "User A's {resource}"

    # User B lists their {resources} (should only see their own)
    response_b = client.get(f"/api/{another_test_user_id}/{resources}")
    data_b = response_b.json()
    assert data_b["total"] == 1
    # assert data_b["{resources}"][0]["title"] == "User B's {resource}"


def test_user_cannot_get_other_users_{resource}(client, test_user_id, another_test_user_id):
    """Test that users cannot get another user's {resource}"""
    # User A creates a {resource}
    create_response = client.post(
        f"/api/{test_user_id}/{resources}",
        json={
            # "title": "User A's {resource}"
        }
    )
    {resource}_id = create_response.json()["id"]

    # User B tries to get User A's {resource} (should return 403)
    response = client.get(f"/api/{another_test_user_id}/{resources}/{{{resource}_id}}")

    assert response.status_code == 403
    assert "access denied" in response.json()["detail"].lower()


def test_user_cannot_update_other_users_{resource}(client, test_user_id, another_test_user_id):
    """Test that users cannot update another user's {resource}"""
    # User A creates a {resource}
    create_response = client.post(
        f"/api/{test_user_id}/{resources}",
        json={
            # "title": "User A's {resource}"
        }
    )
    {resource}_id = create_response.json()["id"]

    # User B tries to update User A's {resource} (should return 403)
    response = client.put(
        f"/api/{another_test_user_id}/{resources}/{{{resource}_id}}",
        json={
            # "title": "Hacked!"
        }
    )

    assert response.status_code == 403
    assert "access denied" in response.json()["detail"].lower()


def test_user_cannot_delete_other_users_{resource}(client, test_user_id, another_test_user_id):
    """Test that users cannot delete another user's {resource}"""
    # User A creates a {resource}
    create_response = client.post(
        f"/api/{test_user_id}/{resources}",
        json={
            # "title": "User A's {resource}"
        }
    )
    {resource}_id = create_response.json()["id"]

    # User B tries to delete User A's {resource} (should return 403)
    response = client.delete(f"/api/{another_test_user_id}/{resources}/{{{resource}_id}}")

    assert response.status_code == 403
    assert "access denied" in response.json()["detail"].lower()

    # Verify {resource} still exists for User A
    get_response = client.get(f"/api/{test_user_id}/{resources}/{{{resource}_id}}")
    assert get_response.status_code == 200


# ===== CUSTOM Tests =====
# Add your custom endpoint tests here

# Example: Test custom status filter
# def test_list_{resources}_filter_by_status(client, test_user_id):
#     """Test filtering {resources} by status"""
#     # Create {resources} with different statuses
#     client.post(f"/api/{test_user_id}/{resources}", json={"title": "Pending", "status": "pending"})
#     client.post(f"/api/{test_user_id}/{resources}", json={"title": "Completed", "status": "completed"})
#
#     # Filter by status
#     response = client.get(f"/api/{test_user_id}/{resources}?status=completed")
#     data = response.json()
#     assert data["total"] == 1
#     assert data["{resources}"][0]["status"] == "completed"
